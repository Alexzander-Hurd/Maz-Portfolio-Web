---
import { Image } from "astro:assets";
import { getCollection } from "astro:content";
import BaseHead from "../components/BaseHead.astro";
import Footer from "../components/Footer.astro";
import Photo from "../components/Photo.astro";
import FormattedDate from "../components/FormattedDate.astro";
import Header from "../components/Header.astro";
import { SITE_DESCRIPTION, SITE_TITLE } from "../consts";

const photos = (await getCollection("photos")).sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// photography.astro (top of file stays the same)
const columns = 3;

// Greedy distribution at build time using intrinsic aspect ratio.
// Add a small fudge factor for the caption/info box so distribution
// accounts for text height too (tweak `textWeight` as needed).
const textWeight = 0.25;

const cols = Array.from({ length: columns }, () => []);
const heights = Array(columns).fill(0);

photos.forEach((photo) => {
  const img = photo.data.image;
  const ratio = img.height / img.width + textWeight;
  const idx = heights.indexOf(Math.min(...heights));
  cols[idx].push(photo);
  heights[idx] += ratio;
});
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
  </head>
  <body>
    <Header />
    <main class="container my-5">
      <!-- Metadata warning banner (Bootstrap 5) -->
      <div class="container-fluid">
        <div
          class="alert alert-warning d-flex align-items-center justify-content-between mb-0"
          role="alert"
          aria-live="polite"
        >
          <div class="d-flex align-items-center">
            <svg
              class="bi flex-shrink-0 me-2"
              width="24"
              height="24"
              role="img"
              aria-hidden="true"
              focusable="false"
            >
              <use xlink:href="#exclamation-triangle-fill"></use>
            </svg>
            <div>
              <strong>Metadata missing:</strong>
              Some photos are currently missing camera metadata (EXIF). Weâ€™re aware
              of this and are restoring full metadata as quickly as possible.
            </div>
          </div>

          <div class="d-flex align-items-center ms-3">
            <small class="me-3 text-muted">Thank you for your patience</small>
            <button
              type="button"
              class="btn btn-sm btn-outline-dark"
              data-bs-dismiss="alert"
              aria-label="Dismiss"
            >
              Dismiss
            </button>
          </div>
        </div>
      </div>

      <!-- Optional: add the SVG symbol in your page (place once, e.g. in the document <body> or a central include) -->
      <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
        <symbol
          id="exclamation-triangle-fill"
          viewBox="0 0 16 16"
          fill="currentColor"
        >
          <path
            d="M8.982 1.566a1.13 1.13 0 0 0-1.964 0L.165 13.233c-.457.778.091 1.767.982 1.767h13.706c.89 0 1.438-.99.982-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1-2.002 0 1 1 0 0 1 2.002 0z"
          ></path>
        </symbol>
      </svg>

      <h2>My Photography</h2>
      <div class="row g-4">
        {
          cols.map(
            () => null
          ) /* keep this line to avoid an unused var warning */
        }
        {
          cols.map((col, colIdx) => (
            <div class="col-sm-12 col-md-6 col-lg-4 d-flex flex-column gap-4">
              {col.map((photo) => (
                <Photo
                  title={photo.data.title}
                  date={photo.data.pubDate}
                  camera={photo.data.camera}
                  lens={photo.data.lens}
                  iso={photo.data.iso}
                  focal={photo.data.focal}
                  shutter={photo.data.shutter}
                  aperture={photo.data.aperture}
                  image={photo.data.image}
                  colour="#facbe0"
                />
              ))}
            </div>
          ))
        }
      </div>
    </main>

    <Footer />
    <script src="../scripts/artinfo.js"></script>
  </body>
</html>
